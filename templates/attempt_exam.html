<!DOCTYPE html>
<html>
<head>
    <title>Attempt Exam: {{ exam.title }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script>
        // Module 3: Timer Logic
        let timeLeft = {{ exam.duration }} * 60;
        function startTimer() {
            const timerDisplay = document.getElementById('timer');
            const interval = setInterval(() => {
                let minutes = Math.floor(timeLeft / 60);
                let seconds = timeLeft % 60;
                timerDisplay.innerText = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                if (timeLeft <= 0) {
                    clearInterval(interval);
                    alert("Time is up! Submitting your exam.");
                    document.getElementById('exam-form').submit();
                }
                timeLeft--;
            }, 1000);
        }

        // Module 4: Anti-Cheat Logic
        let violations = 0;
        const limit = {{ exam.tab_switch_limit }};

        function logViolation() {
            violations++;
            fetch('/api/violation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ exam_id: {{ exam.id }} })
            }).then(res => res.json())
              .then(data => {
                  if (data.count >= limit) {
                      alert("VIOLATION LIMIT EXCEEDED! Your exam is being submitted automatically.");
                      document.getElementById('exam-form').submit();
                  } else {
                      alert(`WARNING: Tab switch detected! (Violation ${data.count}/${limit})`);
                  }
              });
        }

        window.onblur = function() {
            logViolation();
        };

        // Disable right-click, copy, paste
        document.addEventListener('contextmenu', event => event.preventDefault());
        document.addEventListener('copy', event => event.preventDefault());
        document.addEventListener('paste', event => event.preventDefault());

        window.onload = startTimer;
    </script>
</head>
<body oncopy="return false" oncut="return false" onpaste="return false">
    <div class="container">
        <header style="display: flex; justify-content: space-between; align-items: center;">
            <h2>{{ exam.title }}</h2>
            <div id="timer-container" style="background: #333; color: #fff; padding: 10px; border-radius: 5px;">
                Time Remaining: <span id="timer">--:--</span>
            </div>
        </header>
        <p>{{ exam.description }}</p>
        <hr>

        <form id="exam-form" method="POST">
            {% for q in questions %}
            <div class="question-block">
                <p><strong>Q{{ loop.index }}: {{ q.question_text }}</strong></p>
                <label><input type="radio" name="q_{{ q.id }}" value="A"> {{ q.option_a }}</label><br>
                <label><input type="radio" name="q_{{ q.id }}" value="B"> {{ q.option_b }}</label><br>
                <label><input type="radio" name="q_{{ q.id }}" value="C"> {{ q.option_c }}</label><br>
                <label><input type="radio" name="q_{{ q.id }}" value="D"> {{ q.option_d }}</label><br>
            </div>
            <br>
            {% endfor %}
            <button type="submit" class="btn">Submit Exam</button>
        </form>
    </div>
</body>
</html>
